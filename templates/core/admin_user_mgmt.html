{% extends 'base.html' %}

{% block title %}User Management - Mindbloom{% endblock %}

{% block content %}
<style>
    .um-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: 30px;
    }

    .um-search {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .um-search input {
        padding: 10px 18px;
        border-radius: 12px;
        border: 1px solid #E2E8F0;
        font-size: 13px;
        width: 280px;
        background: white;
        outline: none;
        transition: border 0.2s;
    }

    .um-search input:focus {
        border-color: #A0C4FF;
        box-shadow: 0 0 0 3px rgba(160, 196, 255, 0.1);
    }

    .role-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
    }

    .role-tab {
        padding: 8px 20px;
        border-radius: 10px;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        cursor: pointer;
        border: none;
        background: #EDF2F7;
        color: #718096;
    }

    .role-tab.active-tab {
        background: #2D3748;
        color: white;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 16px;
        color: white;
        flex-shrink: 0;
    }

    .online-dot {
        width: 9px;
        height: 9px;
        background: #48BB78;
        border-radius: 50%;
        border: 2px solid white;
        display: inline-block;
        margin-left: 4px;
    }

    .offline-dot {
        background: #CBD5E0;
    }

    .role-pill {
        padding: 3px 10px;
        border-radius: 8px;
        font-size: 10px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .rp-admin {
        background: #EBF8FF;
        color: #2B6CB0;
    }

    .rp-therapist {
        background: #E6FFFA;
        color: #2C7A7B;
    }

    .rp-student {
        background: #F3E8FF;
        color: #6B46C1;
    }

    .action-btn {
        padding: 6px 14px;
        border-radius: 8px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        border: 1px solid #E2E8F0;
        background: white;
        color: #4A5568;
        transition: all 0.2s;
    }

    .action-btn:hover {
        background: #2D3748;
        color: white;
        border-color: #2D3748;
    }

    .um-stats {
        display: flex;
        gap: 16px;
        margin-bottom: 28px;
    }

    .um-stat {
        background: white;
        border-radius: 16px;
        padding: 20px 24px;
        flex: 1;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        border-left: 4px solid transparent;
    }

    .um-stat.students {
        border-color: #9F7AEA;
    }

    .um-stat.therapists {
        border-color: #48BB78;
    }

    .um-stat.admins {
        border-color: #4299E1;
    }

    .um-stat-num {
        font-size: 28px;
        font-weight: 700;
        color: #2D3748;
    }

    .um-stat-lbl {
        font-size: 12px;
        color: #718096;
        font-weight: 600;
        text-transform: uppercase;
        margin-top: 2px;
    }
</style>

<div class="um-header">
    <div>
        <h1 class="welcome-greeting">User Management</h1>
        <p class="welcome-subtext">Community Demographics & Permissions</p>
    </div>
    <div class="um-search">
        <input type="text" id="userSearch" placeholder="ðŸ”  Search members..." onkeyup="filterTable()">
        <button class="check-in-btn" style="padding: 10px 20px; font-size: 13px;">+ Invite Member</button>
    </div>
</div>

<!-- Stats Row -->
<div class="um-stats">
    <div class="um-stat students">
        <div class="um-stat-num">{{ users|length }}</div>
        <div class="um-stat-lbl">All Members</div>
    </div>
    <div class="um-stat therapists">
        <div class="um-stat-num">{% for u in users %}{% if u.profile.role == 'STUDENT' %}âœ”{% endif %}{% endfor %}</div>
        <div style="font-size: 12px; color: #718096; font-weight: 600; text-transform: uppercase; margin-top: 2px;">
            Students</div>
    </div>
    <div class="um-stat admins">
        <div class="um-stat-num">{% for u in users %}{% if u.profile.role == 'THERAPIST' %}âœ”{% endif %}{% endfor %}
        </div>
        <div style="font-size: 12px; color: #718096; font-weight: 600; text-transform: uppercase; margin-top: 2px;">
            Therapists</div>
    </div>
</div>

<!-- Role Filter Tabs -->
<div class="role-tabs">
    <button class="role-tab active-tab" onclick="filterRole('all', this)">All Members</button>
    <button class="role-tab" onclick="filterRole('STUDENT', this)">Students</button>
    <button class="role-tab" onclick="filterRole('THERAPIST', this)">Therapists</button>
    <button class="role-tab" onclick="filterRole('ADMIN', this)">Admins</button>
</div>

<!-- Main Table -->
<div class="card" style="padding: 0; overflow: hidden; border-radius: 20px; border: 1px solid #EDF2F7;">
    <table class="admin-table" id="userTable">
        <thead style="background: #F8FAFC;">
            <tr>
                <th style="padding: 16px;">Member</th>
                <th>Role</th>
                <th>Joined</th>
                <th>Status</th>
                <th>Persona</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for u in users %}
            <tr class="user-row" data-role="{{ u.profile.role }}">
                <td style="padding: 16px;">
                    <div style="display: flex; align-items: center; gap: 14px;">
                        <div class="user-avatar" style="background: {{ u.profile.avatar_color|default:'#769891' }};">
                            {{ u.profile.get_initial }}
                        </div>
                        <div>
                            <div style="font-weight: 700; color: #1A202C; font-size: 14px;">{{ u.username }}</div>
                            <div style="font-size: 11px; color: #A0AEC0;">ID #{{ u.id }}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <span
                        class="role-pill {% if u.profile.role == 'ADMIN' %}rp-admin{% elif u.profile.role == 'THERAPIST' %}rp-therapist{% else %}rp-student{% endif %}">
                        {{ u.profile.role }}
                    </span>
                </td>
                <td style="color: #718096; font-size: 13px;">{{ u.date_joined|date:"M d, Y" }}</td>
                <td>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <span class="profile-tag"
                            style="background: #C6F6D5; color: #22543D; font-size: 10px;">ACTIVE</span>
                        <span class="online-dot"></span>
                    </div>
                </td>
                <td style="font-size: 12px; color: #718096;">{{ u.profile.ai_persona|default:"ZEN" }}</td>
                <td>
                    <div style="display: flex; gap: 6px;">
                        <button class="action-btn">View</button>
                        <button class="action-btn" style="color: #E53E3E; border-color: #FED7D7;"
                            onmouseover="this.style.background='#E53E3E';this.style.color='white'"
                            onmouseout="this.style.background='white';this.style.color='#E53E3E'">Suspend</button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function filterTable() {
        const q = document.getElementById('userSearch').value.toLowerCase();
        document.querySelectorAll('.user-row').forEach(r => {
            r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none';
        });
    }

    function filterRole(role, btn) {
        document.querySelectorAll('.role-tab').forEach(t => t.classList.remove('active-tab'));
        btn.classList.add('active-tab');
        document.querySelectorAll('.user-row').forEach(r => {
            r.style.display = (role === 'all' || r.dataset.role === role) ? '' : 'none';
        });
    }
</script>
{% endblock %}